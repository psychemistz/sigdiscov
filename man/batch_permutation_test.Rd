% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation.R
\name{batch_permutation_test}
\alias{batch_permutation_test}
\title{Batch Permutation Test for Multiple Genes}
\usage{
batch_permutation_test(
  z_f,
  Z_g,
  W,
  metric = c("moran", "ind"),
  n_perm = 999L,
  weight_sum = NULL,
  seed = NULL
)
}
\arguments{
\item{z_f}{Numeric vector. Standardized factor expression (length n_obs).}

\item{Z_g}{Numeric matrix. Gene expression matrix (n_obs x n_genes),
genes in columns.}

\item{W}{Sparse matrix. Weight matrix for computing spatial lags.}

\item{metric}{Character. Either "moran" or "ind".}

\item{n_perm}{Integer. Number of permutations (default: 999).}

\item{weight_sum}{Numeric. Sum of weights for normalization. If NULL or <= 0,
uses n_obs for normalization (default: NULL).}

\item{seed}{Integer. Random seed for reproducibility (optional).}
}
\value{
A data.frame with columns:
\describe{
\item{gene_idx}{Gene index (1-based)}
\item{I_obs}{Observed statistic (Moran's I or I_ND)}
\item{p_value}{Two-sided p-value (bounded between 0 and 1)}
\item{z_score}{Z-score relative to null}
\item{null_sd}{Standard deviation of the null distribution}
}
}
\description{
Efficiently performs permutation tests for one factor against all genes.
Pre-generates permutation indices and reuses them across genes for
consistency and efficiency.
}
\details{
This function is optimized for genome-wide analysis:
\enumerate{
\item Pre-generates all permutation indices once
\item Reuses permutations across all genes (ensures consistency)
\item Computes spatial lag for each gene on-the-fly
\item Checks for user interrupts every 100 genes
}

For a typical analysis with 20,000 genes and 999 permutations,
this processes approximately 20 million permutation statistics.
}
\examples{
\dontrun{
library(Matrix)
set.seed(42)

# Simulate data
n <- 100
n_genes <- 50
z_f <- rnorm(n)
Z_g <- matrix(rnorm(n * n_genes), n, n_genes)
W <- rsparsematrix(n, n, density = 0.1)
W <- W / rowSums(abs(W))  # row normalize

# Run batch test
result <- batch_permutation_test(z_f, Z_g, W, "ind", n_perm = 999)

# All p-values are valid
stopifnot(all(result$p_value >= 0 & result$p_value <= 1, na.rm = TRUE))

# Adjust for multiple testing
result$p_adj <- adjust_pvalues(result$p_value, "BH")
}

}
\seealso{
\code{\link{permutation_test_core}} for single gene test,
\code{\link{adjust_pvalues}} for multiple testing correction
}
