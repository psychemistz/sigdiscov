% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation.R
\name{permutation_test_core}
\alias{permutation_test_core}
\title{Permutation Test for Spatial Correlation (Single Gene)}
\usage{
permutation_test_core(
  z_f,
  lag_g,
  metric = c("moran", "ind"),
  n_perm = 999L,
  seed = NULL
)
}
\arguments{
\item{z_f}{Numeric vector. Standardized factor expression (length n).}

\item{lag_g}{Numeric vector. Pre-computed spatial lag (W * z_g).}

\item{metric}{Character. Either "moran" or "ind".}

\item{n_perm}{Integer. Number of permutations (default: 999).}

\item{seed}{Integer. Random seed for reproducibility (optional).}
}
\value{
A list with components:
\describe{
\item{I_obs}{Observed statistic value}
\item{p_value}{Two-sided p-value (bounded between 0 and 1)}
\item{z_score}{Z-score relative to null distribution}
\item{null_mean}{Mean of null distribution}
\item{null_sd}{Standard deviation of null distribution}
\item{n_perm}{Number of permutations performed}
}
}
\description{
Performs a permutation test to assess the significance of spatial
correlation between a factor and gene expression.
}
\details{
The null hypothesis is that there is no spatial association between
the factor and gene expression. Under the null, factor expression
is randomly distributed in space.

The permutation strategy:
\enumerate{
\item Compute the observed statistic
\item Keep spatial lag fixed (expensive computation done once)
\item Permute factor expression B times
\item p-value = (1 + count(|I_perm| >= |I_obs|)) / (B + 1)
}

The continuity correction ensures p-values are never exactly 0.
}
\examples{
set.seed(42)
n <- 100
z_f <- rnorm(n)
lag_g <- rnorm(n)

# Test with I_ND metric
result <- permutation_test_core(z_f, lag_g, "ind", n_perm = 999)
result$p_value

# P-value is always valid
stopifnot(result$p_value >= 0 && result$p_value <= 1)

}
\seealso{
\code{\link{batch_permutation_test}} for testing multiple genes
}
