% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation_sc.R
\name{moran_permutation_test_sc}
\alias{moran_permutation_test_sc}
\title{Permutation Test for Pairwise Moran's I (Single-Cell Data)}
\usage{
moran_permutation_test_sc(
  data,
  coords,
  radius,
  sigma = NULL,
  n_perm = 999,
  max_cells = 10000,
  seed = NULL,
  verbose = TRUE
)
}
\arguments{
\item{data}{Gene expression matrix (genes x cells). Will be z-normalized.}

\item{coords}{Cell coordinates (n x 2 matrix)}

\item{radius}{Radius for Gaussian weights (in coordinate units)}

\item{sigma}{Gaussian sigma (default: radius/3)}

\item{n_perm}{Number of permutations (default: 999)}

\item{max_cells}{Maximum cells for permutation test (default: 10000).
If n > max_cells, cells are randomly subsampled.}

\item{seed}{Random seed for reproducibility (default: NULL)}

\item{verbose}{Print progress messages (default: TRUE)}
}
\value{
A list containing:
\item{moran}{Observed Moran's I matrix (genes x genes)}
\item{z_scores}{Z-score matrix}
\item{p_values}{Two-sided p-value matrix}
\item{null_sd}{Standard deviation of null distribution}
\item{n_perm}{Number of permutations}
\item{n_cells_used}{Number of cells used (after subsampling if applied)}
\item{subsampled}{Logical, whether subsampling was applied}
}
\description{
Computes p-values for pairwise Moran's I matrix using permutation testing.
Designed for single-cell spatial transcriptomics (CosMx, Xenium, MERFISH).
}
\details{
For large datasets, automatically subsamples cells to make computation
tractable while preserving spatial structure.

The permutation test procedure:
\enumerate{
\item Build sparse weight matrix W from cell coordinates
\item Compute observed Moran's I: M = Z * W * Z^T / S0
\item For each permutation, shuffle cell labels and recompute M
\item P-value = (1 + count(|M_perm| >= |M_obs|)) / (n_perm + 1)
}

For datasets larger than \code{max_cells}, random subsampling is performed
to maintain computational tractability. The spatial structure is preserved
because subsampling is uniform in space.
}
\examples{
\dontrun{
# Load CosMx data
data <- load_data_cosmx("expression.csv", "metadata.csv")

# Run permutation test (will subsample if > 10k cells)
result <- moran_permutation_test_sc(
  data$expr,
  data$coords,
  radius = 50,
  n_perm = 999,
  seed = 42
)

# Find significant pairs
sig_pairs <- extract_significant_pairs(result, threshold = 0.05)
}

}
\seealso{
\code{\link{pairwise_moran_sc_large}}, \code{\link{extract_significant_pairs}}
}
