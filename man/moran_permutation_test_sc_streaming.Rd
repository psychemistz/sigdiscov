% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation_sc.R
\name{moran_permutation_test_sc_streaming}
\alias{moran_permutation_test_sc_streaming}
\title{Streaming Permutation Test for Pairwise Moran's I (Memory Efficient)}
\usage{
moran_permutation_test_sc_streaming(
  data,
  coords,
  radius,
  sigma = NULL,
  n_perm = 999,
  seed = NULL,
  verbose = TRUE
)
}
\arguments{
\item{data}{Gene expression matrix (genes x cells). Will be z-normalized.}

\item{coords}{Cell coordinates (n x 2 matrix)}

\item{radius}{Radius for Gaussian weights (in coordinate units)}

\item{sigma}{Gaussian sigma (default: radius/3)}

\item{n_perm}{Number of permutations (default: 999)}

\item{seed}{Random seed for reproducibility (default: NULL)}

\item{verbose}{Print progress messages (default: TRUE)}
}
\value{
A list containing:
\item{moran}{Observed Moran's I matrix (genes x genes)}
\item{z_scores}{Z-score matrix}
\item{p_values}{Two-sided p-value matrix}
\item{null_sd}{Standard deviation of null distribution}
\item{n_perm}{Number of permutations}
\item{n_cells}{Number of cells}
\item{weight_sum}{Sum of spatial weights (S0)}
\item{n_edges}{Number of neighbor pairs}
}
\description{
Performs permutation test without storing dense weight matrix in memory.
Uses KD-tree neighbor lists to compute spatial lag on-the-fly for each
permutation. Suitable for large datasets (>10k cells) where the dense
approach would run out of memory.
}
\details{
Memory comparison for 98k cells:
\itemize{
\item Dense approach: ~77 GB (stores full weight matrix)
\item Streaming approach: ~1.7 GB (stores only neighbor lists)
}

The streaming approach stores sparse neighbor lists and recomputes
spatial lag for each permutation. This trades computation time for
memory efficiency.

Computational cost per permutation:
\itemize{
\item O(n_cells × avg_neighbors × n_genes) for spatial lag
\item O(n_genes² × n_cells) for Moran's I matrix
}
}
\examples{
\dontrun{
# Load CosMx data (98k cells)
data <- load_data_cosmx("expression.csv", "metadata.csv")

# Run streaming permutation test (no subsampling needed)
result <- moran_permutation_test_sc_streaming(
  data$expr,
  data$coords,
  radius = 0.1,  # 100 um
  n_perm = 999,
  seed = 42
)

# Find significant pairs
sig_pairs <- extract_significant_pairs(result, threshold = 0.05)
}

}
\seealso{
\code{\link{moran_permutation_test_sc}} for dense approach with subsampling
}
