% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation.R
\name{moran_permutation_test}
\alias{moran_permutation_test}
\title{Permutation Test for Pairwise Moran's I Statistical Significance}
\usage{
moran_permutation_test(
  data,
  spot_coords,
  n_perm = 1000,
  seed = NULL,
  max_radius = 5,
  platform = "visium",
  same_spot = FALSE,
  return_null = FALSE,
  verbose = TRUE
)
}
\arguments{
\item{data}{Gene expression matrix (genes x spots). Will be z-normalized
internally if not already normalized.}

\item{spot_coords}{Spot coordinates matrix (n x 2) with columns for row/col
or x/y coordinates.}

\item{n_perm}{Number of permutations. Default: 1000. Higher values give
more precise p-values but take longer.}

\item{seed}{Random seed for reproducibility. Default: NULL (random).}

\item{max_radius}{Maximum grid radius for neighbor search. Default: 5.}

\item{platform}{Platform type: "visium" or "old". Default: "visium".}

\item{same_spot}{Include same-spot weights (diagonal). Default: FALSE.}

\item{return_null}{Return null distribution statistics. Default: FALSE.}

\item{verbose}{Print progress messages. Default: TRUE.}
}
\value{
A list containing:
\item{moran}{Observed Moran's I matrix (genes x genes)}
\item{z_scores}{Z-score matrix from permutation null}
\item{p_values}{Two-sided p-value matrix}
\item{null_sd}{Standard deviation of null distribution}
\item{n_perm}{Number of permutations performed}
\item{null_mean}{Mean of null distribution (if return_null = TRUE)}
}
\description{
Computes p-values and z-scores for the full pairwise Moran's I matrix using
permutation testing. The null hypothesis is that there is no spatial
autocorrelation (values are randomly distributed across spots).
}
\details{
The permutation test works as follows:
\enumerate{
\item Compute observed Moran's I for all gene pairs: M = Z W Z^T / S0
\item For each permutation, shuffle spot labels and recompute Moran's I
\item Calculate z-score: (observed - mean(permuted)) / sd(permuted)
\item Calculate p-value: proportion of |permuted| >= |observed|
}

The p-value formula includes a continuity correction:
p = (1 + count_extreme) / (n_perm + 1)
}
\examples{
\dontrun{
# Load Visium data
visium <- load_visium_data("spaceranger_output")
data_vst <- vst_transform(visium$counts)
spot_coords <- get_spot_coords(visium)

# Run permutation test
result <- moran_permutation_test(
  data_vst,
  spot_coords,
  n_perm = 1000,
  seed = 42
)

# Find significant pairs (FDR < 0.05)
p_adj <- adjust_moran_pvalues(result$p_values, method = "BH")
sig_pairs <- which(p_adj < 0.05 & lower.tri(p_adj), arr.ind = TRUE)
}

}
\seealso{
\code{\link{batch_permutation_test}}, \code{\link{adjust_moran_pvalues}},
\code{\link{extract_significant_pairs}}
}
