#!/bin/sh
# configure script for sigdiscov
# Generates src/Makevars based on platform and available dependencies

# Get R configuration
: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
    echo "Could not determine R_HOME"
    exit 1
fi

CC=`"${R_HOME}/bin/R" CMD config CC`
CXX=`"${R_HOME}/bin/R" CMD config CXX`
CXXFLAGS=`"${R_HOME}/bin/R" CMD config CXXFLAGS`
CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`

# Detect platform
UNAME=`uname -s`
echo "Configuring sigdiscov for ${UNAME}..."

# Initialize flags
OPENMP_CXXFLAGS=""
OPENMP_LIBS=""
EXTRA_LIBS=""

# Check for OpenMP support
echo "Checking for OpenMP support..."

# Get R's OpenMP flags
R_OPENMP=`"${R_HOME}/bin/R" CMD config SHLIB_OPENMP_CXXFLAGS 2>/dev/null`

if test -n "${R_OPENMP}"; then
    # Test if OpenMP actually works
    cat > conftest.cpp << EOF
#include <omp.h>
int main() {
    #pragma omp parallel
    { }
    return 0;
}
EOF

    ${CXX} ${CXXFLAGS} ${CPPFLAGS} ${R_OPENMP} -c conftest.cpp -o conftest.o 2>/dev/null

    if test $? -eq 0; then
        echo "  OpenMP support: yes"
        OPENMP_CXXFLAGS="${R_OPENMP}"
        OPENMP_LIBS="${R_OPENMP}"
    else
        echo "  OpenMP support: no (compilation test failed)"
    fi
    rm -f conftest.cpp conftest.o
else
    echo "  OpenMP support: no (not configured in R)"
fi

# Platform-specific settings
case "${UNAME}" in
    Darwin)
        echo "  Platform: macOS"
        # macOS uses Accelerate framework - FLIBS not needed
        EXTRA_LIBS=""
        ;;
    Linux)
        echo "  Platform: Linux"
        # Linux may need Fortran libs for BLAS/LAPACK
        FLIBS=`"${R_HOME}/bin/R" CMD config FLIBS 2>/dev/null || echo ""`
        EXTRA_LIBS="${FLIBS}"
        ;;
    *)
        echo "  Platform: ${UNAME} (using defaults)"
        EXTRA_LIBS=""
        ;;
esac

# Generate Makevars
echo "Generating src/Makevars..."

cat > src/Makevars << EOF
# Generated by configure script - do not edit by hand

CXX_STD = CXX17

# Armadillo 64-bit word support
PKG_CXXFLAGS = -DARMA_64BIT_WORD ${OPENMP_CXXFLAGS}

# Link libraries
PKG_LIBS = ${OPENMP_LIBS} \$(LAPACK_LIBS) \$(BLAS_LIBS) ${EXTRA_LIBS}
EOF

echo "Configuration complete."
echo ""
echo "Summary:"
echo "  C++ compiler: ${CXX}"
echo "  OpenMP: ${OPENMP_CXXFLAGS:-disabled}"
echo "  Platform: ${UNAME}"
