% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation.R
\name{permutation_test_multi_factor}
\alias{permutation_test_multi_factor}
\title{Vectorized Multi-Factor Permutation Test}
\usage{
permutation_test_multi_factor(
  expr_matrix,
  cell_meta,
  factor_genes,
  sender_type,
  receiver_type,
  radius = 50,
  n_perm = 999,
  seed = NULL,
  adjust_method = "BH",
  verbose = TRUE
)
}
\arguments{
\item{expr_matrix}{Gene expression matrix (genes x cells).}

\item{cell_meta}{Data frame with cell metadata (cell_id, x, y, cell_type).}

\item{factor_genes}{Character vector of factor gene names.}

\item{sender_type}{Sender cell type.}

\item{receiver_type}{Receiver cell type.}

\item{radius}{Distance threshold for weight matrix. Default: 50.}

\item{n_perm}{Number of permutations. Default: 999.}

\item{seed}{Random seed.}

\item{adjust_method}{P-value adjustment method. Default: "BH".}

\item{verbose}{Print progress. Default: TRUE.}
}
\value{
A named list of data.frames, one per factor gene.
}
\description{
Highly optimized permutation test for multiple factor genes using
matrix multiplication. Much faster than running separate tests.
}
\details{
\strong{Optimization Strategy:}
\enumerate{
  \item Precompute spatial lags for ALL genes once: LAG = W x Z_receiver
  \item Generate permutation indices once (shared across factors)
  \item For each factor, use BLAS matrix multiply: I_perm = Z_perm' x LAG
}

This reduces complexity from O(n_factors x n_genes x n_perm x n_senders)
to O(n_genes x n_senders + n_factors x n_perm x n_genes).

\strong{Speedup:} Typically 5-20x faster than separate calls for 5+ factors.
}
\examples{
\dontrun{
# Test multiple cytokines efficiently
results <- permutation_test_multi_factor(
    expr_matrix = expr,
    cell_meta = meta,
    factor_genes = c("IL1B", "TGFB1", "IFNG", "TNF", "IL6"),
    sender_type = "Macrophage",
    receiver_type = "Fibroblast",
    n_perm = 999
)

# Combine results with FDR correction across all tests
all_results <- do.call(rbind, lapply(names(results), function(f) {
    df <- results[[f]]
    df$factor <- f
    df
}))
all_results$p_adj_global <- p.adjust(all_results$p_value, method = "BH")
}

}
