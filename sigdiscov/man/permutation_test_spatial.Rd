% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/permutation.R
\name{permutation_test_spatial}
\alias{permutation_test_spatial}
\title{Permutation Test for Spatial Correlation}
\usage{
permutation_test_spatial(
  expr_matrix,
  cell_meta = NULL,
  spot_coords = NULL,
  factor_gene,
  sender_type = NULL,
  receiver_type = NULL,
  radius = NULL,
  mode = c("directional", "bivariate"),
  metric = c("ind", "moran"),
  n_perm = 999,
  seed = NULL,
  adjust_method = "BH",
  verbose = TRUE
)
}
\arguments{
\item{expr_matrix}{Gene expression matrix (genes x cells/spots).}

\item{cell_meta}{Data frame with cell metadata (for single-cell mode).
Must contain: cell_id, x, y, cell_type.}

\item{spot_coords}{Coordinate matrix or data frame for Visium (spots x 2).}

\item{factor_gene}{Name or index of factor gene.}

\item{sender_type}{Sender cell type (for single-cell directional mode).}

\item{receiver_type}{Receiver cell type (for single-cell directional mode).}

\item{radius}{Distance threshold for weight matrix. Default: 50 for single-cell, 200 for Visium.}

\item{mode}{"bivariate" (all cells/spots) or "directional" (sender to receiver).}

\item{metric}{"moran" (Moran's I) or "ind" (I_ND, default).}

\item{n_perm}{Number of permutations. Default: 999.}

\item{seed}{Random seed for reproducibility.}

\item{adjust_method}{P-value adjustment method. Default: "BH" (Benjamini-Hochberg).}

\item{verbose}{Print progress. Default: TRUE.}
}
\value{
A data.frame with columns:
  \item{gene}{Gene name}
  \item{I_obs}{Observed statistic (Moran's I or I_ND)}
  \item{p_value}{Permutation p-value}
  \item{p_adj}{Adjusted p-value (FDR)}
  \item{z_score}{Standardized effect size}
}
\description{
Performs permutation test for Moran's I or I_ND to assess statistical
significance of spatial association between factor and gene expression.
}
\details{
\strong{Permutation Strategy:}
The test permutes the factor expression while keeping the spatial lag fixed.
This is efficient because:
\enumerate{
  \item Spatial lag (W * z_g) is computed once per gene
  \item Permutation involves only cheap vector operations
  \item Same permutation indices are reused across all genes
}

\strong{P-value Calculation:}
\deqn{p = \frac{1 + \sum I(|I^{(b)}| \geq |I_{obs}|)}{B + 1}}

The "+1" provides continuity correction and ensures p > 0.
}
\examples{
\dontrun{
# Visium: Bivariate Moran's I test
result <- permutation_test_spatial(
    expr_matrix = expr_vst,
    spot_coords = coords,
    factor_gene = "IL1B",
    mode = "bivariate",
    metric = "moran",
    n_perm = 999
)

# CosMx: Directional I_ND test (cell-type specific)
result <- permutation_test_spatial(
    expr_matrix = cosmx_expr,
    cell_meta = meta,
    factor_gene = "IL1B",
    sender_type = "Macrophage",
    receiver_type = "Fibroblast",
    mode = "directional",
    metric = "ind",
    n_perm = 999
)

# Significant genes (FDR < 0.05)
sig_genes <- result[result$p_adj < 0.05, ]
}

}
